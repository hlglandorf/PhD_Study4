---
title: "PsychxBiomed_Joining"
author: "H.L. Glandorf"
date: "2024-04-05"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Psych x Biomed Study Joining Files
This code file prepares the data for the next stage (data analysis).

These are the objectives:
- reverse coding for questionnaires with negatively worded items
- calculate component scores for PSQI (sleep measure)
- check internal consistency of each questionnaire
- calculate total scores for each questionnaire
- create alternative scoring for some questionnaires (to make them comparable to other research)
- pre-process biomedical data
- join questionnaire and biomedical data frames
- join waves into one data frame

# Load relevant libraries
```{r libraries}
library(tidyverse)
library(ggplot2)
library(psych)
library(readxl)
library(semTools)
```

# Load data
Questionnaire data and biomedical data is loaded in separately. Each eave (1-3) is also separate.
```{r data}
qdat1 <- read_excel("S4_W1_qdata.xlsx", col_types = c("text", "numeric", "text", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", 
                                                      "text", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", 
                                                      "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", 
                                                      "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", 
                                                      "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", 
                                                      "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "text", "numeric", "numeric", "numeric", 
                                                      "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", 
                                                      "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric"), na = "NA")
qdat2 <- read_excel("S4_W2_qdata.xlsx", col_types = c("text","numeric", "text", "numeric", "text", "text", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", 
                                                      "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", 
                                                      "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", 
                                                      "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", 
                                                      "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "text", "numeric", 
                                                      "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", 
                                                      "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", 
                                                      "numeric"), na = "NA")
qdat3 <- read_excel("S4_W3_qdata.xlsx", col_types = c("text","numeric", "text", "numeric", "text", "text", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", 
                                                      "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", 
                                                      "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", 
                                                      "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", 
                                                      "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "text", "numeric", 
                                                      "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", 
                                                      "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", 
                                                      "numeric"), na = "NA")
biom1 <- read_excel("W1salivasamples_flowchecked.xlsx", col_types = c("text", "text", "text", "text", "text", "text", "numeric", "text", "text", "numeric", "numeric", "numeric", 
                                                                      "numeric", "numeric", "numeric", "text"), na = "NA")
biom2 <- read_excel("W2.2salivasamples_clean.xlsx", col_types = c("numeric", "text", "text", "numeric", "numeric", "numeric", "numeric", "numeric", "text", "numeric", 
                                                                   "numeric", "numeric", "numeric", "numeric", "numeric", "text"), na = "NA")
biom3 <- read_excel("W3.2_salivasamples_clean.xlsx", col_types = c("numeric", "text", "text", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", "numeric", 
                                                                   "numeric", "numeric", "text"), na = "NA")
```

# Reverse coding for negatively worded items on the ABQ and the CES-D (DS)
```{r reverse coding}
qdat1 <- qdat1 %>% mutate(ABQ1_rev = recode(ABQ1,
                                       `4`=0,
                                       `3`=1,
                                       `2`=2,
                                       `1`=3,
                                       `0`=4),
                        ABQ14_rev = recode(ABQ14,
                                       `4`=0,
                                       `3`=1,
                                       `2`=2,
                                       `1`=3,
                                       `0`=4),
                        DS12_rev = recode(DS12,
                                        `3`=0,
                                        `2`=1,
                                        `1`=2,
                                        `0`=3),
                        DS16_rev = recode(DS16,
                                        `3`=0,
                                        `2`=1,
                                        `1`=2,
                                        `0`=3))
qdat2 <- qdat2 %>% mutate(ABQ1_rev = recode(ABQ1,
                                       `4`=0,
                                       `3`=1,
                                       `2`=2,
                                       `1`=3,
                                       `0`=4),
                        ABQ14_rev = recode(ABQ14,
                                       `4`=0,
                                       `3`=1,
                                       `2`=2,
                                       `1`=3,
                                       `0`=4),
                        DS12_rev = recode(DS12,
                                        `3`=0,
                                        `2`=1,
                                        `1`=2,
                                        `0`=3),
                        DS16_rev = recode(DS16,
                                        `3`=0,
                                        `2`=1,
                                        `1`=2,
                                        `0`=3))
qdat3 <- qdat3 %>% mutate(ABQ1_rev = recode(ABQ1,
                                       `4`=0,
                                       `3`=1,
                                       `2`=2,
                                       `1`=3,
                                       `0`=4),
                        ABQ14_rev = recode(ABQ14,
                                       `4`=0,
                                       `3`=1,
                                       `2`=2,
                                       `1`=3,
                                       `0`=4),
                        DS12_rev = recode(DS12,
                                        `3`=0,
                                        `2`=1,
                                        `1`=2,
                                        `0`=3),
                        DS16_rev = recode(DS16,
                                        `3`=0,
                                        `2`=1,
                                        `1`=2,
                                        `0`=3))
```

# Determine component scores for the PSQI 
```{r compute PSQI component scores}
qdat1 <- qdat1 %>% mutate(
  PSQIc1 = PSQI9,
  PSQI2sub = case_when(PSQI2 > 60 ~ 3,
                       PSQI2 > 30 ~ 2,
                       PSQI2 > 15 ~ 1,
                       TRUE ~ 0),
  PSQIc2sub = PSQI2sub + PSQI5a,
  PSQIc2 = case_when(PSQIc2sub > 4 ~ 3,
                     PSQIc2sub > 2 ~ 2,
                     PSQIc2sub > 0 ~ 1,
                     TRUE ~ 0),
  PSQIc3 = case_when(PSQI4 > 7 ~ 0,
                     PSQI4 > 6 ~ 1,
                     PSQI4 > 5 ~ 2,
                     TRUE ~ 0),
  PSQI1sub = ifelse(PSQI1 > 18, PSQI1, PSQI1+24),
  PSQI3sub = PSQI3 + 24,
  PSQI13 = PSQI3sub-PSQI1sub,
  PSQIc4sub = (PSQI4/PSQI13)*100,
  PSQIc4 = case_when(PSQIc4sub > 85 ~ 0,
                     PSQIc4sub > 74 ~ 1,
                     PSQIc4sub > 64 ~ 2,
                     TRUE ~ 3),
  PSQIc5sub = PSQI5b+PSQI5c+PSQI5d+PSQI5e+PSQI5f+PSQI5g+PSQI5h+PSQI5i+PSQI5j,
  PSQIc5 = case_when(PSQIc5sub > 18 ~ 3,
                     PSQIc5sub > 9 ~ 2,
                     PSQIc5sub > 0 ~ 1,
                     TRUE ~ 0),
  PSQIc6 = PSQI6,
  PSQIc7sub = PSQI7+PSQI8,
  PSQIc7 = case_when(PSQIc7sub > 4 ~ 3,
                     PSQIc7sub > 2 ~ 2,
                     PSQIc7sub > 0 ~ 1,
                     TRUE ~ 0))
qdat2 <- qdat2 %>% mutate(
  PSQIc1 = PSQI9,
  PSQI2sub = case_when(PSQI2 > 60 ~ 3,
                       PSQI2 > 30 ~ 2,
                       PSQI2 > 15 ~ 1,
                       TRUE ~ 0),
  PSQIc2sub = PSQI2sub + PSQI5a,
  PSQIc2 = case_when(PSQIc2sub > 4 ~ 3,
                     PSQIc2sub > 2 ~ 2,
                     PSQIc2sub > 0 ~ 1,
                     TRUE ~ 0),
  PSQIc3 = case_when(PSQI4 > 7 ~ 0,
                     PSQI4 > 6 ~ 1,
                     PSQI4 > 5 ~ 2,
                     TRUE ~ 0),
  PSQI1sub = ifelse(PSQI1 > 18, PSQI1, PSQI1+24),
  PSQI3sub = PSQI3 + 24,
  PSQI13 = PSQI3sub-PSQI1sub,
  PSQIc4sub = (PSQI4/PSQI13)*100,
  PSQIc4 = case_when(PSQIc4sub > 85 ~ 0,
                     PSQIc4sub > 74 ~ 1,
                     PSQIc4sub > 64 ~ 2,
                     TRUE ~ 3),
  PSQIc5sub = PSQI5b+PSQI5c+PSQI5d+PSQI5e+PSQI5f+PSQI5g+PSQI5h+PSQI5i+PSQI5j,
  PSQIc5 = case_when(PSQIc5sub > 18 ~ 3,
                     PSQIc5sub > 9 ~ 2,
                     PSQIc5sub > 0 ~ 1,
                     TRUE ~ 0),
  PSQIc6 = PSQI6,
  PSQIc7sub = PSQI7+PSQI8,
  PSQIc7 = case_when(PSQIc7sub > 4 ~ 3,
                     PSQIc7sub > 2 ~ 2,
                     PSQIc7sub > 0 ~ 1,
                     TRUE ~ 0))
qdat3 <- qdat3 %>% mutate(
  PSQIc1 = PSQI9,
  PSQI2sub = case_when(PSQI2 > 60 ~ 3,
                       PSQI2 > 30 ~ 2,
                       PSQI2 > 15 ~ 1,
                       TRUE ~ 0),
  PSQIc2sub = PSQI2sub + PSQI5a,
  PSQIc2 = case_when(PSQIc2sub > 4 ~ 3,
                     PSQIc2sub > 2 ~ 2,
                     PSQIc2sub > 0 ~ 1,
                     TRUE ~ 0),
  PSQIc3 = case_when(PSQI4 > 7 ~ 0,
                     PSQI4 > 6 ~ 1,
                     PSQI4 > 5 ~ 2,
                     TRUE ~ 0),
  PSQI1sub = ifelse(PSQI1 > 18, PSQI1, PSQI1+24),
  PSQI3sub = PSQI3 + 24,
  PSQI13 = PSQI3sub-PSQI1sub,
  PSQIc4sub = (PSQI4/PSQI13)*100,
  PSQIc4 = case_when(PSQIc4sub > 85 ~ 0,
                     PSQIc4sub > 74 ~ 1,
                     PSQIc4sub > 64 ~ 2,
                     TRUE ~ 3),
  PSQIc5sub = PSQI5b+PSQI5c+PSQI5d+PSQI5e+PSQI5f+PSQI5g+PSQI5h+PSQI5i+PSQI5j,
  PSQIc5 = case_when(PSQIc5sub > 18 ~ 3,
                     PSQIc5sub > 9 ~ 2,
                     PSQIc5sub > 0 ~ 1,
                     TRUE ~ 0),
  PSQIc6 = PSQI6,
  PSQIc7sub = PSQI7+PSQI8,
  PSQIc7 = case_when(PSQIc7sub > 4 ~ 3,
                     PSQIc7sub > 2 ~ 2,
                     PSQIc7sub > 0 ~ 1,
                     TRUE ~ 0))
```

# Internal consistency checks
```{r internal consistency}
##total burnout
model_tb <-'
# measurement model
tb =~ ABQ2+ABQ4+ABQ8+ABQ10+ABQ12+ABQ3+ABQ5+ABQ9+ABQ11+ABQ15+ABQ1_rev+ABQ5+ABQ7+ABQ13+ABQ14_rev
'
fit_tb <- lavaan::sem(model = model_tb, data = qdat1, missing = "ml")
summary(fit_tb, fit.measures=TRUE, rsquare = T, standardized = T)
semTools::reliability(fit_tb)

##exhaustion
model_exh <-'
# measurement model
exh =~ ABQ2+ABQ4+ABQ8+ABQ10+ABQ12
'
fit_exh <- lavaan::sem(model = model_exh, data = qdat1, missing = "ml")
summary(fit_exh, fit.measures=TRUE, rsquare = T, standardized = T)
semTools::reliability(fit_exh)

##devaluation
model_dev <-'
# measurement model
dev =~ ABQ3+ABQ5+ABQ9+ABQ11+ABQ15
'
fit_dev <- lavaan::sem(model = model_dev, data = qdat1, missing = "ml")
summary(fit_dev, fit.measures=TRUE, rsquare = T, standardized = T)
semTools::reliability(fit_dev)

##RSA
model_rsa <-'
# measurement model
dev =~ ABQ1_rev+ABQ5+ABQ7+ABQ13+ABQ14_rev
'
fit_rsa <- lavaan::sem(model = model_rsa, data = qdat1, missing = "ml")
summary(fit_rsa, fit.measures=TRUE, rsquare = T, standardized = T)
semTools::reliability(fit_rsa)

#PSC
model_psc <-'
#measurement model
psc =~ PSC1+PSC2+PSC3+PSC4+PSC5+PSC6+PSC7+PSC8+PSC9+PSC10+PSC11+PSC12+PSC13+PSC14+PSC15+PSC16+PSC17+PSC18
'
fit_psc <- lavaan::sem(model = model_psc, data = qdat1, missing = "ml")
summary(fit_psc, fit.measures=TRUE, rsquare = T, standardized = T)
semTools::reliability(fit_psc)

#DS
model_ds <-'
#measurement model
ds =~ DS1+DS2+DS3+DS4+DS5+DS6+DS7+DS8+DS9+DS10+DS11+DS12_rev+DS13+DS14+DS15+DS16_rev+DS17+DS18+DS19+DS20
'
fit_ds <- lavaan::sem(model = model_ds, data = qdat1, missing = "ml")
summary(fit_ds, fit.measures=TRUE, rsquare = T, standardized = T)
semTools::reliability(fit_ds)

#PSQI
model_psqi <-'
#measurement model
psqi =~ PSQIc1+PSQIc2+PSQIc3+PSQIc4+PSQIc5+PSQIc6+PSQIc7
'
fit_psqi <- lavaan::sem(model = model_psqi, data = qdat1, missing = "ml")
summary(fit_psqi, fit.measures=TRUE, rsquare = T, standardized = T)
semTools::reliability(fit_psqi) ## component 3 has to be removed for the scale to reach reliability 

#ISI
model_isi <-'
#measurement model
isi =~ ISI1+ISI2+ISI3+ISI4+ISI5+ISI6+ISI7
'
fit_isi <- lavaan::sem(model = model_isi, data = qdat1, missing = "ml")
summary(fit_isi, fit.measures=TRUE, rsquare = T, standardized = T)
semTools::reliability(fit_isi)
```

# Calculate total scores
```{r total scores}
qdat1 <- qdat1 %>% mutate(
  t1time = time,
  t1timeeat = time_eaten,
  t1season = season,
  t1meds = meds,
  t1trainload = train_load,
  t1EXH = (ABQ2+ABQ4+ABQ8+ABQ10+ABQ12)/5,
  t1DEV = (ABQ3+ABQ5+ABQ9+ABQ11+ABQ15)/5,
  t1RSA = (ABQ1_rev+ABQ5+ABQ7+ABQ13+ABQ14_rev)/5,
  t1TB = (ABQ2+ABQ4+ABQ8+ABQ10+ABQ12+ABQ3+ABQ5+ABQ9+ABQ11+ABQ15+ABQ1_rev+ABQ5+ABQ7+ABQ13+ABQ14_rev)/15,
  t1PS = PSC1+PSC2+PSC3+PSC4+PSC5+PSC6+PSC7+PSC8+PSC9+PSC10+PSC11+PSC12+PSC13+PSC14+PSC15+PSC16+PSC17+PSC18,
  t1DS = DS1+DS2+DS3+DS4+DS5+DS6+DS7+DS8+DS9+DS10+DS11+DS12_rev+DS13+DS14+DS15+DS16_rev+DS17+DS18+DS19+DS20,
  t1PSQI = PSQIc1+PSQIc2+PSQIc4+PSQIc5+PSQIc6+PSQIc7, #removal of component 3 for internal consistency is considered in total score
  t1ISI = ISI1+ISI2+ISI3+ISI4+ISI5+ISI6+ISI7
)
qdat2 <- qdat2 %>% mutate(
  t2time = time,
  t2timeeat = time_eaten,
  t2season = season,
  t2meds = meds,
  t2trainload = train_load,
  t2EXH = (ABQ2+ABQ4+ABQ8+ABQ10+ABQ12)/5,
  t2DEV = (ABQ3+ABQ5+ABQ9+ABQ11+ABQ15)/5,
  t2RSA = (ABQ1_rev+ABQ5+ABQ7+ABQ13+ABQ14_rev)/5,
  t2TB = (ABQ2+ABQ4+ABQ8+ABQ10+ABQ12+ABQ3+ABQ5+ABQ9+ABQ11+ABQ15+ABQ1_rev+ABQ5+ABQ7+ABQ13+ABQ14_rev)/15,
  t2PS = PSC1+PSC2+PSC3+PSC4+PSC5+PSC6+PSC7+PSC8+PSC9+PSC10+PSC11+PSC12+PSC13+PSC14+PSC15+PSC16+PSC17+PSC18,
  t2DS = DS1+DS2+DS3+DS4+DS5+DS6+DS7+DS8+DS9+DS10+DS11+DS12_rev+DS13+DS14+DS15+DS16_rev+DS17+DS18+DS19+DS20,
  t2PSQI = PSQIc1+PSQIc2+PSQIc4+PSQIc5+PSQIc6+PSQIc7,
  t2ISI = ISI1+ISI2+ISI3+ISI4+ISI5+ISI6+ISI7
)
qdat3 <- qdat3 %>% mutate(
  t3time = time,
  t3timeeat = time_eaten,
  t3season = season,
  t3meds = meds,
  t3trainload = train_load,
  t3EXH = (ABQ2+ABQ4+ABQ8+ABQ10+ABQ12)/5,
  t3DEV = (ABQ3+ABQ5+ABQ9+ABQ11+ABQ15)/5,
  t3RSA = (ABQ1_rev+ABQ5+ABQ7+ABQ13+ABQ14_rev)/5,
  t3TB = (ABQ2+ABQ4+ABQ8+ABQ10+ABQ12+ABQ3+ABQ5+ABQ9+ABQ11+ABQ15+ABQ1_rev+ABQ5+ABQ7+ABQ13+ABQ14_rev)/15,
  t3PS = PSC1+PSC2+PSC3+PSC4+PSC5+PSC6+PSC7+PSC8+PSC9+PSC10+PSC11+PSC12+PSC13+PSC14+PSC15+PSC16+PSC17+PSC18,
  t3DS = DS1+DS2+DS3+DS4+DS5+DS6+DS7+DS8+DS9+DS10+DS11+DS12_rev+DS13+DS14+DS15+DS16_rev+DS17+DS18+DS19+DS20,
  t3PSQI = PSQIc1+PSQIc2+PSQIc4+PSQIc5+PSQIc6+PSQIc7,
  t3ISI = ISI1+ISI2+ISI3+ISI4+ISI5+ISI6+ISI7
)
```

# Alternative scale coding for ABQ (1-5 instead of 0-4) and PSC (1-7 instead of 0-6)
This is required, so the descriptive statistics can be compared to other research that uses the 1-5 and 1-7 scales.
```{r alt scale recoding}
qdat1 <- qdat1 %>% mutate(ABQ1d = recode(ABQ1_rev,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ2d = recode(ABQ2,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ3d = recode(ABQ3,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ4d = recode(ABQ4,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ5d = recode(ABQ5,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ6d = recode(ABQ6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ7d = recode(ABQ7,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ8d = recode(ABQ8,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ9d = recode(ABQ9,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ10d = recode(ABQ10,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ11d = recode(ABQ11,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ12d = recode(ABQ12,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ13d = recode(ABQ13,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ14d = recode(ABQ14_rev,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ15d = recode(ABQ15,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC1d = recode(PSC1,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC2d = recode(PSC2,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC3d = recode(PSC3,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC4d = recode(PSC4,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC5d = recode(PSC5,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC6d = recode(PSC6,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC7d = recode(PSC7,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC8d = recode(PSC8,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC9d = recode(PSC9,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC10d = recode(PSC10,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC11d = recode(PSC11,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC12d = recode(PSC12,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC13d = recode(PSC13,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC14d = recode(PSC14,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC15d = recode(PSC15,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC16d = recode(PSC16,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC17d = recode(PSC17,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC18d = recode(PSC18,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          t1EXHd = (ABQ2d+ABQ4d+ABQ8d+ABQ10d+ABQ12d)/5,
                          t1DEVd = (ABQ3d+ABQ5d+ABQ9d+ABQ11d+ABQ15d)/5,
                          t1RSAd = (ABQ1d+ABQ5d+ABQ7d+ABQ13d+ABQ14d)/5,
                          t1TBd = (ABQ2d+ABQ4d+ABQ8d+ABQ10d+ABQ12d+ABQ3d+ABQ5d+ABQ9d+ABQ11d+ABQ15d+ABQ1d+ABQ5d+ABQ7d+ABQ13d+ABQ14d)/15,
                          t1PSd = PSC1d+PSC2d+PSC3d+PSC4d+PSC5d+PSC6d+PSC7d+PSC8d+PSC9d+PSC10d+PSC11d+PSC12d+PSC13d+PSC14d+PSC15d+PSC16d+PSC17d+PSC18d
                        )
qdat2 <- qdat2 %>% mutate(ABQ1d = recode(ABQ1_rev,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ2d = recode(ABQ2,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ3d = recode(ABQ3,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ4d = recode(ABQ4,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ5d = recode(ABQ5,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ6d = recode(ABQ6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ7d = recode(ABQ7,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ8d = recode(ABQ8,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ9d = recode(ABQ9,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ10d = recode(ABQ10,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ11d = recode(ABQ11,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ12d = recode(ABQ12,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ13d = recode(ABQ13,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ14d = recode(ABQ14_rev,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ15d = recode(ABQ15,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC1d = recode(PSC1,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC2d = recode(PSC2,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC3d = recode(PSC3,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC4d = recode(PSC4,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC5d = recode(PSC5,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC6d = recode(PSC6,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC7d = recode(PSC7,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC8d = recode(PSC8,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC9d = recode(PSC9,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC10d = recode(PSC10,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC11d = recode(PSC11,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC12d = recode(PSC12,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC13d = recode(PSC13,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC14d = recode(PSC14,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC15d = recode(PSC15,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC16d = recode(PSC16,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC17d = recode(PSC17,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC18d = recode(PSC18,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          t2EXHd = (ABQ2d+ABQ4d+ABQ8d+ABQ10d+ABQ12d)/5,
                          t2DEVd = (ABQ3d+ABQ5d+ABQ9d+ABQ11d+ABQ15d)/5,
                          t2RSAd = (ABQ1d+ABQ5d+ABQ7d+ABQ13d+ABQ14d)/5,
                          t2TBd = (ABQ2d+ABQ4d+ABQ8d+ABQ10d+ABQ12d+ABQ3d+ABQ5d+ABQ9d+ABQ11d+ABQ15d+ABQ1d+ABQ5d+ABQ7d+ABQ13d+ABQ14d)/15,
                          t2PSd = PSC1d+PSC2d+PSC3d+PSC4d+PSC5d+PSC6d+PSC7d+PSC8d+PSC9d+PSC10d+PSC11d+PSC12d+PSC13d+PSC14d+PSC15d+PSC16d+PSC17d+PSC18d
                        )
qdat3 <- qdat3 %>% mutate(ABQ1d = recode(ABQ1_rev,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ2d = recode(ABQ2,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ3d = recode(ABQ3,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ4d = recode(ABQ4,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ5d = recode(ABQ5,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ6d = recode(ABQ6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ7d = recode(ABQ7,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ8d = recode(ABQ8,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ9d = recode(ABQ9,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ10d = recode(ABQ10,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ11d = recode(ABQ11,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ12d = recode(ABQ12,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ13d = recode(ABQ13,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ14d = recode(ABQ14_rev,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          ABQ15d = recode(ABQ15,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC1d = recode(PSC1,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC2d = recode(PSC2,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC3d = recode(PSC3,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC4d = recode(PSC4,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC5d = recode(PSC5,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC6d = recode(PSC6,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC7d = recode(PSC7,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC8d = recode(PSC8,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC9d = recode(PSC9,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC10d = recode(PSC10,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC11d = recode(PSC11,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC12d = recode(PSC12,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC13d = recode(PSC13,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC14d = recode(PSC14,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC15d = recode(PSC15,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC16d = recode(PSC16,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC17d = recode(PSC17,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          PSC18d = recode(PSC18,
                                       `6`=7,
                                       `5`=6,
                                       `4`=5,
                                       `3`=4,
                                       `2`=3,
                                       `1`=2,
                                       `0`=1),
                          t3EXHd = (ABQ2d+ABQ4d+ABQ8d+ABQ10d+ABQ12d)/5,
                          t3DEVd = (ABQ3d+ABQ5d+ABQ9d+ABQ11d+ABQ15d)/5,
                          t3RSAd = (ABQ1d+ABQ5d+ABQ7d+ABQ13d+ABQ14d)/5,
                          t3TBd = (ABQ2d+ABQ4d+ABQ8d+ABQ10d+ABQ12d+ABQ3d+ABQ5d+ABQ9d+ABQ11d+ABQ15d+ABQ1d+ABQ5d+ABQ7d+ABQ13d+ABQ14d)/15,
                          t3PSd = PSC1d+PSC2d+PSC3d+PSC4d+PSC5d+PSC6d+PSC7d+PSC8d+PSC9d+PSC10d+PSC11d+PSC12d+PSC13d+PSC14d+PSC15d+PSC16d+PSC17d+PSC18d
                        )
```

# Reduce dataframes to variables being taken forward to analysis
```{r reduce}
qdatw1 <- qdat1 %>% select(sample_id, sex, age, sport_type, injury, comp_experience, comp_level, 
                           t1time, t1timeeat, t1season, t1trainload, t1meds,
                           t1EXH, t1DEV, t1RSA, t1TB, t1PS, t1DS, t1PSQI, t1ISI, 
                           t1EXHd, t1DEVd, t1RSAd, t1TBd, t1PSd)
qdatw2 <- qdat2 %>% select(sample_id,  
                           t2time, t2timeeat, t2season, t2trainload, t2meds,
                           t2EXH, t2DEV, t2RSA, t2TB, t2PS, t2DS, t2PSQI, t2ISI, 
                           t2EXHd, t2DEVd, t2RSAd, t2TBd, t2PSd)
qdatw3 <- qdat3 %>% select(sample_id, 
                           t3time, t3timeeat, t3season, t3trainload, t3meds,
                           t3EXH, t3DEV, t3RSA, t3TB, t3PS, t3DS, t3PSQI, t3ISI, 
                           t3EXHd, t3DEVd, t3RSAd, t3TBd, t3PSd)
```

# Pre-processing for biomed data
Some of the biomarkers need to be corrected for flowrate (e.g., DHEA-S and IgA). The others only receive a tag with the respective wave here.
```{r pre-processing}
biom1 <- biom1 %>% mutate(t1iga_flow = iga_conc*flowrate,
                          t1dheas_flow = dheas_conc*flowrate,
                          t1iga_conc = iga_conc,
                          t1test_conc = test_conc,
                          t1dheas_conc = dheas_conc,
                          t1cort_conc = cort_conc,
                          t1crp_conc = crp_conc,
                          t1notes = notes)
biom2 <- biom2 %>% mutate(t2iga_flow = iga_conc*flowrate,
                          t2dheas_flow = dheas_conc*flowrate,
                          t2iga_conc = iga_conc,
                          t2test_conc = test_conc,
                          t2dheas_conc = dheas_conc,
                          t2cort_conc = cort_conc,
                          t2crp_conc = crp_conc,
                          t2notes = notes)
biom3 <- biom3 %>% mutate(t3iga_flow = iga_conc*flowrate,
                          t3dheas_flow = dheas_conc*flowrate,
                          t3iga_conc = iga_conc,
                          t3test_conc = test_conc,
                          t3dheas_conc = dheas_conc,
                          t3cort_conc = cort_conc,
                          t3crp_conc = crp_conc,
                          t3notes = notes)
```

# Selecting relevant data to move forward
```{r selection}
biomw1 <- biom1 %>% select(sample_id, t1iga_flow, t1iga_conc, t1test_conc, t1dheas_flow, t1dheas_conc, t1cort_conc, t1crp_conc, t1notes)
biomw2 <- biom2 %>% select(sample_id, t2iga_flow, t2iga_conc, t2test_conc, t2dheas_flow, t2dheas_conc, t2cort_conc, t2crp_conc, t2notes)
biomw3 <- biom3 %>% select(sample_id, t3iga_flow, t3iga_conc, t3test_conc, t3dheas_flow, t3dheas_conc, t3cort_conc, t3crp_conc, t3notes)
```

# Joining the questionnaire and biomed data
```{r joining data}
wave1 <- inner_join(qdatw1, biomw1, by = join_by(sample_id))
wave2 <- inner_join(qdatw2, biomw2, by = join_by(sample_id))
wave3 <- inner_join(qdatw3, biomw3, by = join_by(sample_id))
```

# Joining the waves together
Data is joined in two formats. The first format only includes participants who have completed at least two waves (longitudinal data). The second format includes all data that has been collected (cross-sectional and longitudinal). 
```{r joining waves}
##data with participants who have two or more waves completed
half1 <- merge(wave2, wave3, by = "sample_id", all = T) 
half1$sample_id <- as.numeric(half1$sample_id)
half1 <- filter(half1, !is.na(sample_id))
half1$sample_id <- as.character(half1$sample_id)
half2 <- inner_join(wave1, half1, by = "sample_id") 
half2$sample_id <- as.numeric(half2$sample_id)
half2 <- arrange(half2, sample_id)

#full dataframe
full <- list(wave1, wave2, wave3) %>% reduce(full_join, by="sample_id")
```

# Write-out dataframes
```{r write out}
write.csv(half2, "redframe.csv")
write.csv(full, "fullframe.csv")
```